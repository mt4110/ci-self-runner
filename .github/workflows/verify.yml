name: verify

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - "codex/**"
  pull_request:

permissions:
  contents: read

jobs:
  verify-lite:
    if: ${{ vars.SELF_HOSTED_OWNER != '' && github.repository_owner == vars.SELF_HOSTED_OWNER && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false) }}
    runs-on:
      - self-hosted
      - mac-mini
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff
        with:
          go-version-file: go.mod

      - name: Verify Lite
        run: go run ./cmd/verify-lite

      - name: Append Verify Lite Status To Job Summary
        if: always()
        run: |
          echo "## verify-lite.status" >> "$GITHUB_STEP_SUMMARY"
          cat out/verify-lite.status >> "$GITHUB_STEP_SUMMARY" || echo "(missing: out/verify-lite.status)" >> "$GITHUB_STEP_SUMMARY"

      - name: Evaluate Verify Lite Status
        if: always()
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b
        with:
          script: |
            const fs = require('fs');
            const path = 'out/verify-lite.status';
            if (!fs.existsSync(path)) {
              core.setFailed('verify-lite.status missing');
            } else {
              const content = fs.readFileSync(path, 'utf8');
              if (content.includes('ERROR:') || content.includes('status=ERROR')) {
                core.setFailed('verify-lite reported ERROR');
              }
            }

      - name: Notify Discord (CI Alerts)
        if: always()
        continue-on-error: true
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: go run ./cmd/notify_discord --status out/verify-lite.status --title "verify-lite" --webhook-env DISCORD_WEBHOOK_URL --min-level ERROR

  verify-full-dryrun:
    if: ${{ vars.SELF_HOSTED_OWNER != '' && github.repository_owner == vars.SELF_HOSTED_OWNER && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false) }}
    needs: verify-lite
    runs-on:
      - self-hosted
      - mac-mini
      - colima
      - verify-full
    timeout-minutes: 40
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Verify Full (Dry-Run + GHA Sync)
        env:
          VERIFY_DRY_RUN: "1"
          VERIFY_GHA_SYNC: "1"
          GITHUB_ACTIONS: "true"
        run: ops/ci/run_verify_full.sh

      - name: Append Verify Full Status To Job Summary
        if: always()
        run: |
          echo "## verify-full.status" >> "$GITHUB_STEP_SUMMARY"
          cat out/verify-full.status >> "$GITHUB_STEP_SUMMARY" || echo "(missing: out/verify-full.status)" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Verify Full Artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: verify-full-dryrun-${{ github.run_id }}
          if-no-files-found: warn
          path: |
            out/verify-full.status
            out/logs/**

      - name: Evaluate Verify Full Status
        if: always()
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b
        with:
          script: |
            const fs = require('fs');
            const path = 'out/verify-full.status';
            if (!fs.existsSync(path)) {
              core.setFailed('verify-full.status missing');
            } else {
              const content = fs.readFileSync(path, 'utf8');
              if (content.includes('ERROR:') || content.includes('status=ERROR')) {
                core.setFailed('verify-full reported ERROR');
              }
            }

      - name: Notify Discord (CI Alerts)
        if: always()
        continue-on-error: true
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: go run ./cmd/notify_discord --status out/verify-full.status --title "verify-full-dryrun" --webhook-env DISCORD_WEBHOOK_URL --min-level ERROR
